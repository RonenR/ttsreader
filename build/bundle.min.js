!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,(function(r){return o(e[i][1][r]||r)}),p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){window.wsGlobals=window.wsGlobals||{},window.wsGlobals.TtsEngine=require("./index").TtsEngine},{"./index":5}],2:[function(require,module,exports){const{ServerVoices:ServerVoices}=require("./serverVoices");class ServerTts{static voices=ServerVoices.voices;static buffer=[];static currentAudio=null;static listener={onInit:voices=>{},onStart:id=>{},onDone:id=>{},onError:(id,error)=>{},onReady:id=>{}};static getVoices(){return ServerTts.voices}static init(listener){listener&&(ServerTts.listener=listener),ServerTts.listener.onInit(ServerTts.voices)}static async bufferNewUtterance(text,voiceURI,rate,id,authToken,onSuccess,onError){let utterance={text:text,voiceURI:voiceURI,rate:rate,id:id,wasPlayed:!1,audio:null};const existingUtterance=ServerTts.buffer.find((u=>u.id===id));if(existingUtterance&&existingUtterance.audio)return existingUtterance.wasPlayed=!1,ServerTts.buffer=ServerTts.buffer.filter((u=>u.id!==id)),ServerTts.buffer.push(existingUtterance),void onSuccess();try{const response=await fetch("https://us-central1-ttsreader.cloudfunctions.net/tts",{method:"POST",headers:{Authorization:`Bearer ${authToken}`,"Content-Type":"application/json"},body:JSON.stringify({text:text,lang:voiceURI.replace("ttsreaderServer.gcp.","").split("-").slice(0,2).join("-"),voice:voiceURI,rate:rate})});if(!response.ok)throw new Error(`Server returned status ${response.status}`);const blob=await response.blob(),url=URL.createObjectURL(blob);utterance.audio=new Audio(url)}catch(error){return void onError(error.message)}for(ServerTts.buffer.push(utterance);ServerTts.buffer.length>20&&ServerTts.buffer[0].wasPlayed;)ServerTts.buffer.shift();onSuccess()}static async speak(id,listener){ServerTts.stop();const getUtterance=()=>ServerTts.buffer.find((u=>u.id===id));let utterance=getUtterance();if(!utterance)return ServerTts.listener.onError(id,"Utterance not found in buffer");let waited=0;for(;!utterance.audio&&waited<1e4;)await new Promise((r=>setTimeout(r,200))),waited+=200,utterance=getUtterance();utterance.audio?(listener.onStart(id),ServerTts.currentAudio=utterance.audio,ServerTts.currentAudio.onended=()=>{utterance.wasPlayed=!0,listener.onDone(id)},ServerTts.currentAudio.onerror=()=>{listener.onError(id,"Audio playback failed")},ServerTts.currentAudio.play().catch((err=>{listener.onError(id,err.message)}))):listener.onError(id,"Audio not available after 10s")}static stop(){ServerTts.currentAudio&&(ServerTts.currentAudio.pause(),ServerTts.currentAudio.currentTime=0)}}void 0!==module&&(module.exports={ServerTts:ServerTts})},{"./serverVoices":3}],3:[function(require,module,exports){class ServerVoices{static voices=[{voiceURI:"ttsreaderServer.gcp.en-US-Standard-F",name:"Olivia Premium",lang:"en-US",localService:!1,default:!0,premiumLevel:1,gender:"f",avatar:"https://storage.ttsreader.com/images/voices/oliviaNew.webp",demo:"https://storage.ttsreader.com/audio/voices/oliviaNew.mp3"},{voiceURI:"ttsreaderServer.gcp.en-US-Chirp-HD-D",name:"Noah Premium",lang:"en-US",localService:!1,default:!0,premiumLevel:2,gender:"m",avatar:"https://storage.ttsreader.com/images/voices/noahNew.webp",demo:"https://storage.ttsreader.com/audio/voices/noahNew.mp3"}]}void 0!==module&&(module.exports={ServerVoices:ServerVoices})},{}],4:[function(require,module,exports){const SHA256=require("crypto-js/sha256"),{ServerTts:ServerTts}=require("./serverTts");function codeToLanguageCodeOnly(code){return null==code||code.length<2?"":code.toLowerCase().split("-")[0].split("_")[0]}function doCodesShareLanguage(a,b){return codeToLanguageCodeOnly(a)==codeToLanguageCodeOnly(b)}exports.TtsEngine={DEFAULT_LANG:"en",voice:{},voices:[],rate:1,utteranceId:0,startedAndNotTerminatedCounter:0,listener:null,utterance:{},_googleBugTimeout:null,_speakTimeout:null,_canceledAtMs:0,_isServerTTS:!1,_defaultListener:{onInit:voices=>{},onStart:()=>{},onDone:()=>{},onError:error=>{}},init:function(listener,isToAddServerTTS){listener&&this.setListener(listener,isToAddServerTTS),this._isServerTTS=isToAddServerTTS||!1,this._populateVoices(isToAddServerTTS),speechSynthesis.onvoiceschanged=()=>{this._populateVoices(isToAddServerTTS)}},setListener:function(listener,isToAddServerTTS){this.listener=listener||this._defaultListener},setBestMatchingVoice:function(voice,voiceURI,lang){if(null==this.voices||0==this.voices.length)return"";if(voice&&voice.voiceURI||voiceURI||lang||(this.voice&&this.voice.voiceURI?voiceURI=this.voice.voiceURI:lang=this.DEFAULT_LANG),voice&&(voiceURI=voice.voiceURI||voiceURI),voiceURI)for(const iVoice of this.voices)if(iVoice.voiceURI==voiceURI)return this.voice=iVoice,iVoice.voiceURI;if(lang){if(this.voice&&doCodesShareLanguage(this.voice.lang,lang))return this.voice.voiceURI;let filteredVoices=this.voices.filter((iVoice=>doCodesShareLanguage(iVoice.lang,lang)));if(filteredVoices&&filteredVoices.length>0){if(1==filteredVoices.length)return this.voice=filteredVoices[0],this.voice.voiceURI;if(!lang.startsWith("en")&&!lang.startsWith("es"))return this.voice=filteredVoices[0],this.voice.voiceURI;{let selectedVoice,selectedVoiceScore=-1;for(const iVoice of filteredVoices){let score=0;iVoice.localService&&(score+=1.5),2==iVoice.lang.length?score+=3:-1!=["en-us","en-uk","en-gb","es-es"].indexOf(iVoice.lang.toLowerCase().replace("_","-"))?score+=4:-1==["en-in"].indexOf(iVoice.lang.toLowerCase().replace("_","-"))&&(score+=2),score>selectedVoiceScore&&(selectedVoiceScore=score,selectedVoice=iVoice)}if(selectedVoice)return this.voice=selectedVoice,this.voice.voiceURI}}}for(const iVoice of this.voices)if(this.voice=iVoice,iVoice.localService)return iVoice.voiceURI;return this.voice.voiceURI},_populateVoices:function(isToAddServerTTS){let voices=window.speechSynthesis.getVoices();if(voices&&!(voices.length<1)){if(isToAddServerTTS){let additionalVoices=ServerTts.getVoices();for(const additionalVoice of additionalVoices)voices.push(additionalVoice)}voices&&voices.length>0&&(this.voices=voices.filter((voice=>{if(!voice.voiceURI.includes("com.apple.eloquence")&&!voice.voiceURI.includes("com.apple.speech.synthesis"))return voice})),this.setBestMatchingVoice(this.voice,null,null),this.listener&&this.listener.onInit&&this.listener.onInit(this.voices))}},setVoiceByUri:function(voiceURI){this.setBestMatchingVoice(null,voiceURI,null)},getVoiceURI:function(){return this.voice||this.setBestMatchingVoice(),this.voice?this.voice.voiceURI:""},setRate:function(rate){"string"==typeof rate&&(rate=Number(rate)),isNaN(rate)||(rate<.1&&(rate=.1),rate>4&&(rate=4),this.rate=rate)},isInitiated:function(){return null!=this.voices},_runOnWebspeechApiStart:function(ev){this.startedAndNotTerminatedCounter++,this._solveChromeBug()},_runOnWebspeechApiEnd:function(ev){this.startedAndNotTerminatedCounter>0&&this.startedAndNotTerminatedCounter--,this._clearUtteranceTimeouts()},_runOnWebspeechApiError:function(ev){this.startedAndNotTerminatedCounter>0&&this.startedAndNotTerminatedCounter--,this._clearUtteranceTimeouts()},_clearUtteranceTimeouts:function(){null!=this._googleBugTimeout&&(window.clearTimeout(this._googleBugTimeout),this._googleBugTimeout=null)},_solveChromeBug:function(){if(!this.voice)return;if(-1===this.voice.voiceURI.toLowerCase().indexOf("google"))return;this._clearUtteranceTimeouts();let self=this;this._googleBugTimeout=window.setTimeout((function(){window.speechSynthesis.pause(),window.speechSynthesis.resume(),self._solveChromeBug()}),1e4)},_prepareTextForSynthesis:function(text){let decodedText=text;return decodedText=decodedText.replace("Â·",", "),decodedText=decodedText.replace("- ",", "),decodedText.trim(),decodedText},speakAndBuffer:function(utt,bufferArray,authToken){if(utt.voiceURI.startsWith("ttsreaderServer")){let text=this._prepareTextForSynthesis(utt.text),id=""+SHA256(text+utt.voiceURI+utt.rate);ServerTts.bufferNewUtterance(text,utt.voiceURI,utt.rate,id,authToken,(()=>{ServerTts.speak(id,{onStart:this.listener.onStart,onDone:this.listener.onDone,onError:this.listener.onError})}),(error=>{this.listener.onError("Error buffering utterance: ",error)}));for(const bufferUtt of bufferArray){let bufferText=this._prepareTextForSynthesis(bufferUtt.text),bufferId=""+SHA256(bufferText+bufferUtt.voiceURI+bufferUtt.rate);ServerTts.bufferNewUtterance(bufferText,bufferUtt.voiceURI,bufferUtt.rate,bufferId,authToken,(()=>{}),(error=>{}))}}else this.setVoiceByUri(utt.voiceURI),this.setRate(utt.rate),this.speakOut(utt.text)},speakOut:function(text){let instance=this;if(this.startedAndNotTerminatedCounter>0||window.speechSynthesis.paused||window.speechSynthesis.pending||window.speechSynthesis.speaking)return this.stop(),void(this._speakTimeout=window.setTimeout((function(){instance.speakOut(text)}),200));if(!text)return void(this.utterance&&this.utterance.onend());if(text=this._prepareTextForSynthesis(text),!this.isInitiated())return!1;this.utteranceId++;let utterance=new SpeechSynthesisUtterance;this.utterance=utterance,utterance.text=text,null==this.voice&&this.setBestMatchingVoice(null,null,null),this.voice&&(utterance.lang=this.voice.lang,utterance.voiceURI=this.voice.voiceURI,utterance.voice=this.voice),utterance.rate=this.rate;let self=this;utterance.onmark=function(ev){},utterance.onstart=function(ev){self._runOnWebspeechApiStart(ev),self.listener&&self.listener.onStart&&self.listener.onStart()},utterance.onboundary=function(event){},utterance.onend=function(ev){self._runOnWebspeechApiEnd(ev),self.listener&&self.listener.onDone&&self.listener.onDone(),utterance=null},utterance.onerror=function(ev){self._runOnWebspeechApiError(ev),utterance=null},this._speakUtterance(utterance)},stop(){ServerTts.stop(),null!=this._speakTimeout&&(window.clearTimeout(this._speakTimeout),this._speakTimeout=null),window.speechSynthesis.cancel(),this.startedAndNotTerminatedCounter=0,this._canceledAtMs=Date.now()},_speakUtterance(utterance){null!=this._speakTimeout&&(window.clearTimeout(this._speakTimeout),this._speakTimeout=null),window.speechSynthesis.paused&&window.speechSynthesis.resume(),Date.now()-this._canceledAtMs>100?window.speechSynthesis.speak(utterance):this._speakTimeout=window.setTimeout((function(){window.speechSynthesis.speak(utterance)}),200)}}},{"./serverTts":2,"crypto-js/sha256":7}],5:[function(require,module,exports){exports.TtsEngine=require("./helpers/ttsEngine").TtsEngine},{"./helpers/ttsEngine":4}],6:[function(require,module,exports){(function(global){(function(){var root,factory;root=this,factory=function(){var CryptoJS=CryptoJS||function(Math,undefined){var crypto;if("undefined"!=typeof window&&window.crypto&&(crypto=window.crypto),"undefined"!=typeof self&&self.crypto&&(crypto=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(crypto=globalThis.crypto),!crypto&&"undefined"!=typeof window&&window.msCrypto&&(crypto=window.msCrypto),!crypto&&void 0!==global&&global.crypto&&(crypto=global.crypto),!crypto&&"function"==typeof require)try{crypto=require("crypto")}catch(err){}var cryptoSecureRandomInt=function(){if(crypto){if("function"==typeof crypto.getRandomValues)try{return crypto.getRandomValues(new Uint32Array(1))[0]}catch(err){}if("function"==typeof crypto.randomBytes)try{return crypto.randomBytes(4).readInt32LE()}catch(err){}}throw new Error("Native crypto module could not be used to get secure random number.")},create=Object.create||function(){function F(){}return function(obj){var subtype;return F.prototype=obj,subtype=new F,F.prototype=null,subtype}}(),C={},C_lib=C.lib={},Base=C_lib.Base={extend:function(overrides){var subtype=create(this);return overrides&&subtype.mixIn(overrides),subtype.hasOwnProperty("init")&&this.init!==subtype.init||(subtype.init=function(){subtype.$super.init.apply(this,arguments)}),subtype.init.prototype=subtype,subtype.$super=this,subtype},create:function(){var instance=this.extend();return instance.init.apply(instance,arguments),instance},init:function(){},mixIn:function(properties){for(var propertyName in properties)properties.hasOwnProperty(propertyName)&&(this[propertyName]=properties[propertyName]);properties.hasOwnProperty("toString")&&(this.toString=properties.toString)},clone:function(){return this.init.prototype.extend(this)}},WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:4*words.length},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words,thatWords=wordArray.words,thisSigBytes=this.sigBytes,thatSigBytes=wordArray.sigBytes;if(this.clamp(),thisSigBytes%4)for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}else for(var j=0;j<thatSigBytes;j+=4)thisWords[thisSigBytes+j>>>2]=thatWords[j>>>2];return this.sigBytes+=thatSigBytes,this},clamp:function(){var words=this.words,sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8,words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);return clone.words=this.words.slice(0),clone},random:function(nBytes){for(var words=[],i=0;i<nBytes;i+=4)words.push(cryptoSecureRandomInt());return new WordArray.init(words,nBytes)}}),C_enc=C.enc={},Hex=C_enc.Hex={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,hexChars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16)),hexChars.push((15&bite).toString(16))}return hexChars.join("")},parse:function(hexStr){for(var hexStrLength=hexStr.length,words=[],i=0;i<hexStrLength;i+=2)words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4;return new WordArray.init(words,hexStrLength/2)}},Latin1=C_enc.Latin1={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,latin1Chars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){for(var latin1StrLength=latin1Str.length,words=[],i=0;i<latin1StrLength;i++)words[i>>>2]|=(255&latin1Str.charCodeAt(i))<<24-i%4*8;return new WordArray.init(words,latin1StrLength)}},Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}},BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init,this._nDataBytes=0},_append:function(data){"string"==typeof data&&(data=Utf8.parse(data)),this._data.concat(data),this._nDataBytes+=data.sigBytes},_process:function(doFlush){var processedWords,data=this._data,dataWords=data.words,dataSigBytes=data.sigBytes,blockSize=this.blockSize,nBlocksReady=dataSigBytes/(4*blockSize),nWordsReady=(nBlocksReady=doFlush?Math.ceil(nBlocksReady):Math.max((0|nBlocksReady)-this._minBufferSize,0))*blockSize,nBytesReady=Math.min(4*nWordsReady,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize)this._doProcessBlock(dataWords,offset);processedWords=dataWords.splice(0,nWordsReady),data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0}),C_algo=(C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg),this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},update:function(messageUpdate){return this._append(messageUpdate),this._process(),this},finalize:function(messageUpdate){return messageUpdate&&this._append(messageUpdate),this._doFinalize()},blockSize:16,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}}),C.algo={});return C}(Math);return CryptoJS},"object"==typeof exports?module.exports=exports=factory():"function"==typeof define&&define.amd?define([],factory):root.CryptoJS=factory()}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{crypto:8}],7:[function(require,module,exports){var root,factory;root=this,factory=function(CryptoJS){return function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,H=[],K=[];!function(){function isPrime(n){for(var sqrtN=Math.sqrt(n),factor=2;factor<=sqrtN;factor++)if(!(n%factor))return!1;return!0}function getFractionalBits(n){return 4294967296*(n-(0|n))|0}for(var n=2,nPrime=0;nPrime<64;)isPrime(n)&&(nPrime<8&&(H[nPrime]=getFractionalBits(Math.pow(n,.5))),K[nPrime]=getFractionalBits(Math.pow(n,1/3)),nPrime++),n++}();var W=[],SHA256=C_algo.SHA256=Hasher.extend({_doReset:function(){this._hash=new WordArray.init(H.slice(0))},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7],i=0;i<64;i++){if(i<16)W[i]=0|M[offset+i];else{var gamma0x=W[i-15],gamma0=(gamma0x<<25|gamma0x>>>7)^(gamma0x<<14|gamma0x>>>18)^gamma0x>>>3,gamma1x=W[i-2],gamma1=(gamma1x<<15|gamma1x>>>17)^(gamma1x<<13|gamma1x>>>19)^gamma1x>>>10;W[i]=gamma0+W[i-7]+gamma1+W[i-16]}var maj=a&b^a&c^b&c,sigma0=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),t1=h+((e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25))+(e&f^~e&g)+K[i]+W[i];h=g,g=f,f=e,e=d+t1|0,d=c,c=b,b=a,a=t1+(sigma0+maj)|0}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0,H[5]=H[5]+f|0,H[6]=H[6]+g|0,H[7]=H[7]+h|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});C.SHA256=Hasher._createHelper(SHA256),C.HmacSHA256=Hasher._createHmacHelper(SHA256)}(Math),CryptoJS.SHA256},"object"==typeof exports?module.exports=exports=factory(require("./core")):"function"==typeof define&&define.amd?define(["./core"],factory):factory(root.CryptoJS)},{"./core":6}],8:[function(require,module,exports){},{}]},{},[1]);
